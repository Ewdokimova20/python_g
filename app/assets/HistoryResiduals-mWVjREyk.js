import{k as Z,d as M,s as de,a5 as ve,r as y,w as ee,o as v,c as V,u as l,t as D,v as w,a as g,b as c,g as N,F as H,h as me,e as k,at as B,as as $,A as pe,H as z,f as fe,j as ce,S as x,au as O,av as ye,p as J,aw as I,ax as ae,ay as be,G as he,E as ge,l as E,ar as ke,m as X,a4 as Se,ap as _e,_ as Le,B as Q,az as Te,Q as G,R as Ne}from"./index-B9ncFhZ9.js";import{b as Ie}from"./bis-Bw-5DPa6.js";import{s as Re}from"./inputswitch.esm-v0smpIrf.js";const Ue=Z();function Ee(o){var p,n;return(n=(p=Ue.nkaList)==null?void 0:p.find(b=>b.sysNum===o))==null?void 0:n.nkuNum}const we=o=>`${o} (${Ee(o)??"-"})`,xe={class:"p-component"},Ae={key:0},Ve=M({__name:"HistoryResidualsTableView",setup(o,{expose:p}){const n=de({url:"/history_residuals",startImmediately:!1}),b=ve(),h=Z(),a=y({}),m=y(),L=y(20),u={nka:{value:null,matchMode:O.EQUALS},bis:{value:null,matchMode:O.EQUALS},signal1:{value:null,matchMode:O.EQUALS},signalIsUntrusted:{value:null,matchMode:O.EQUALS},rejectedDueToDeviation:{value:null,matchMode:O.EQUALS}},T=[{value:!0,label:"Да"},{value:!1,label:"Нет"}],S=e=>{switch(e){case!0:return"warning";case!1:return"success";default:return"info"}},i=y(u),U=()=>{const{filters:e,...s}=a.value;a.value=s},C=()=>{const{sort:e,...s}=a.value;a.value=s},F=()=>{a.value={...a.value,limit:L.value,page:1}},P=()=>{i.value={...u},U()};function q(e){n.available=!1,a.value={...e,limit:L.value,page:1},n.post(a.value),P(),F()}function R(){n.post(a.value),F()}const t=()=>Object.fromEntries(Object.entries({...i.value}).map(([e,s])=>s.value===""?[e,{...s,value:null}]:[e,s])),d=e=>{const{page:s,rows:A}=e;a.value={...a.value,limit:A,page:s+1},R()},ne=()=>{const e=t();Object.values({...e}).map(s=>s.value).every(s=>s===null)?U():a.value={...a.value,filters:e,page:1,limit:L.value},R()},re=e=>{const{sortOrder:s}=e;let{sortField:A}=e;A?(A=ye.decamelize(A),a.value={...a.value,sort:{sortField:A,sortOrder:s}}):C(),R()},ie=[{field:"timestamp",header:"Время привязки",handler:J,sortable:!0},{field:"bis",header:"БИС",handler:Ie},{field:"nka",header:"НКА",handler:we},{field:"signal1",header:"Тип сигнала 1",handler:e=>z[e]},{field:"signal2",header:"Тип сигнала 2",handler:e=>z[e]},{field:"nkaElevation",header:"Угол места",handler:e=>e&&e.toFixed(1)},{field:"delta",header:"Отклонение невязки ПД (ddS)",handler:e=>e&&e.toFixed(3),sortable:!0},{field:"delta1",header:"Отклонение невязки ПД (ddS), сигнал 1",handler:e=>e&&e.toFixed(3)},{field:"delta2",header:"Отклонение невязки ПД (ddS), сигнал 2",handler:e=>e&&e.toFixed(3)},{field:"residual",header:"Невязка ПД",sortable:!0,handler:e=>e&&e.toFixed(3)},{field:"average",header:"Средняя невязка ПД",handler:e=>e&&e.toFixed(3)},{field:"rejectedDueToDeviation",header:"Отбраковано",handler:e=>e??(e?"Да":"Нет")},{field:"signalIsUntrusted",header:"Признак недостоверности",handler:e=>e??(e?"Да":"Нет")},{field:"speedResidual",header:"Невязка ПC",handler:e=>e!==void 0&&e.toFixed(3),sortable:!0},{field:"dbTimestamp",header:"Время записи в БД",handler:J,sortable:!0}];return ee(()=>n.error,e=>{if(e){const s=e==null?void 0:e.response;s?s.status===404?(m.value=I.NOT_FOUND,n.data={data:[],totalRecords:0}):s.status===400?m.value=I.INSUFFICIENT_PARAMS:s.status===401?m.value=s.data:m.value=I.DEFAULT:e!=null&&e.request?m.value=I.NO_CONNECTION:m.value=I.DEFAULT}else m.value=""}),p({getResiduals:q,checkIfLoading:()=>n.posting}),(e,s)=>{var A,K,W,Y;return v(),V("div",xe,[((A=l(n).data)==null?void 0:A.totalRecords)!==void 0?(v(),V("div",Ae," Найдено записей: "+D((K=l(n).data)==null?void 0:K.totalRecords),1)):w("",!0),l(n).available?(v(),g(l(ce),{key:1,ref:"dt",filters:i.value,"onUpdate:filters":s[0]||(s[0]=f=>i.value=f),value:(W=l(n).data)==null?void 0:W.data,class:"p-datatable-sm","responsive-layout":"scroll",paginator:"",lazy:"",rows:L.value,"filter-display":"row","rows-per-page-options":[20,50],"total-records":(Y=l(n).data)==null?void 0:Y.totalRecords,loading:l(n).posting,"removable-sort":"",scrollable:"",onPage:s[1]||(s[1]=f=>d(f)),onFilter:s[2]||(s[2]=f=>ne()),onSort:s[3]||(s[3]=f=>re(f))},{empty:c(()=>s[4]||(s[4]=[N(" Ничего не найдено ")])),default:c(()=>[(v(),V(H,null,me(ie,(f,ue)=>k(l(fe),{key:ue,field:f.field||void 0,header:f.header||"",sortable:f.sortable||!1,"show-filter-menu":!1},{body:c(({data:_})=>[["rejectedDueToDeviation","signalIsUntrusted"].includes(f.field)?f.field==="rejectedDueToDeviation"?(v(),g(l(B),{key:1,value:_.rejectedDueToDeviation?"Да":"Нет",severity:S(_.rejectedDueToDeviation)},null,8,["value","severity"])):f.field==="signalIsUntrusted"?(v(),g(l(B),{key:2,value:_.signalIsUntrusted?"Да":"Нет",severity:S(_.signalIsUntrusted)},null,8,["value","severity"])):w("",!0):(v(),V(H,{key:0},[N(D(f.handler?f.handler(_[f.field]):_[f.field]),1)],64))]),loading:c(()=>s[5]||(s[5]=[N(" Загрузка... ")])),filter:c(({filterModel:_,filterCallback:j})=>[_?(v(),V(H,{key:0},[f.field==="bis"?(v(),g(l($),{key:0,modelValue:_.value,"onUpdate:modelValue":r=>_.value=r,"empty-message":"Нет доступных БИС",options:l(b).bisList,"option-label":r=>`${r.stationId}/${r.bisNumber}`,"option-value":r=>r.bisId,placeholder:"Фильтр",class:"p-column-filter",style:{"min-width":"4rem"},onChange:r=>j()},null,8,["modelValue","onUpdate:modelValue","options","option-label","option-value","onChange"])):w("",!0),f.field==="nka"?(v(),g(l($),{key:1,modelValue:_.value,"onUpdate:modelValue":r=>_.value=r,"empty-message":"Нет доступных БИС",options:l(h).nkaList,"option-label":r=>`${r.sysNum} (${r.nkuNum})`,"option-value":r=>r.sysNum,placeholder:"Фильтр",class:"p-column-filter",style:{"min-width":"4rem"},onChange:r=>j()},null,8,["modelValue","onUpdate:modelValue","options","option-label","option-value","onChange"])):w("",!0),f.field==="signal1"?(v(),g(l($),{key:2,modelValue:_.value,"onUpdate:modelValue":r=>_.value=r,"empty-message":"Нет доступных БИС",options:l(pe),placeholder:"Фильтр",class:"p-column-filter",style:{"min-width":"4rem"},onChange:r=>j()},{option:c(({option:r})=>[N(D(l(z)[r]),1)]),_:2},1032,["modelValue","onUpdate:modelValue","options","onChange"])):w("",!0),["rejectedDueToDeviation","signalIsUntrusted"].includes(f.field)?(v(),g(l($),{key:3,modelValue:_.value,"onUpdate:modelValue":r=>_.value=r,options:T,"option-label":r=>r.label,"option-value":r=>r.value,placeholder:"Фильтр",class:"p-column-filter",style:{"min-width":"6rem"},onChange:r=>j()},{option:c(({option:r})=>[k(l(B),{value:r.label,severity:S(r.value)},null,8,["value","severity"])]),_:2},1032,["modelValue","onUpdate:modelValue","option-label","option-value","onChange"])):w("",!0)],64)):w("",!0)]),_:2},1032,["field","header","sortable"])),64))]),_:1},8,["filters","value","rows","total-records","loading"])):m.value?(v(),g(l(x),{key:2,severity:"error",closable:!1},{default:c(()=>[N(D(m.value),1)]),_:1})):(v(),g(l(x),{key:3,severity:"info",closable:!1},{default:c(()=>s[6]||(s[6]=[N("Нет данных для отображения")])),_:1}))])}}}),le=(o,p,n)=>{const b=new Blob([o],{type:p}),h=document.createElement("a");h.href=URL.createObjectURL(b),h.download=n,h.click(),URL.revokeObjectURL(h.href)};function se(o,p){const n=a=>{if(a==null)return"";if(Array.isArray(a)){if(a.length===1)return a[0].toString();if(a.length>1)return`${a[0]}_${a[a.length-1]}`}return typeof a=="number"?a.toString():""},b=a=>a?a.replace(/[:]/g,"-"):"";return[o,"bis",n(p.bis),"signal_type",n(p.signalType),"nka",n(p.nka),b(p.start),b(p.end)].filter(Boolean).join("_")}const Ce=o=>se("graph",o),Fe=o=>se("residuals",o),De={class:"p-component"},$e=M({__name:"HistoryResidualsCSVImport",setup(o,{expose:p}){const n=y({}),b=y(!1),h=y(!1),a=y();async function m(L){n.value=L,b.value=!0,a.value="",h.value=!1;try{const u=await ae.post("/residuals_csv",n.value);le(u.data,"text/csv",`${Fe(n.value)}.csv`),h.value=!0}catch(u){if(be.isAxiosError(u)){const T=u;if(u.response)switch(u.response.status){case 404:a.value=I.NOT_FOUND;break;case 400:a.value=I.INSUFFICIENT_PARAMS;break;case 401:a.value=u.response.data;break;default:a.value=I.DEFAULT}else u.request?a.value=I.NO_CONNECTION:a.value=T.message||I.DEFAULT}}finally{b.value=!1}}return p({downloadCSV:m}),(L,u)=>(v(),V("div",De,[h.value?(v(),g(l(x),{key:0,severity:"success",closable:!1},{default:c(()=>u[0]||(u[0]=[N("Успешно")])),_:1})):b.value?(v(),g(l(x),{key:1,severity:"info",closable:!1},{default:c(()=>u[1]||(u[1]=[N("Идет загрузка...")])),_:1})):a.value?(v(),g(l(x),{key:2,severity:"error",closable:!1},{default:c(()=>[N(D(a.value),1)]),_:1})):(v(),g(l(x),{key:3,severity:"info",closable:!1},{default:c(()=>u[2]||(u[2]=[N("Выберите параметры для выгрузки невязок")])),_:1}))]))}});var te=(o=>(o.LINES="lines",o.MARKERS="markers",o.LINES_MARKERS="lines+markers",o))(te||{}),oe=(o=>(o.DELTA="delta",o.DELTA1="delta1",o.DELTA2="delta2",o.RESIDUAL="residual",o.RESIDUAL1="residual1",o.RESIDUAL2="residual2",o.SPEED_RESIDUAL="speed_residual",o.AVERAGE="average",o.NKA_ELEVATION="nka_elevation",o))(oe||{});const Oe=[{name:"Отклонение невязки от среднего (ddS)",value:"delta"},{name:"Невязка (dS)",value:"residual"},{name:"Средняя невязка ПД",value:"average"},{name:"Угол места НКА",value:"nka_elevation"},{name:"Отклонение невязки от среднего (ddS1), сигнал 1",value:"delta1"},{name:"Отклонение невязки от среднего (ddS2), сигнал 2",value:"delta2"},{name:"Невязка (dS1), сигнал 1",value:"residual1"},{name:"Невязка (dS2), сигнал 2",value:"residual2"},{name:"Невязка ПС",value:"speed_residual"}],Pe=[{name:"Линия с маркерами",value:"lines+markers"},{name:"Маркеры",value:"markers"},{name:"Линия",value:"lines"}],je=[{name:"10 c",value:10},{name:"30 c",value:30},{name:"1 мин",value:60}],He={class:"p-component"},Me={class:"controls-container pt-3"},qe={class:"mb-3 flex gap-3 justify-content-center align-items-center"},Be={class:"p-float-label"},ze={class:"p-float-label"},Qe={class:"p-float-label"},Ge={class:"p-float-label"},Ke={class:"flex align-items-center mr-auto"},We=M({__name:"HistoryResidualsHTMLImport",setup(o,{expose:p}){const n=y({}),b=y(!1),h=y(!1),a=y(),m=y(),L=y(!1),u=y(null);let T="",S=null;const i=he({dataField:oe.DELTA,lineType:te.MARKERS,timeStep:60,displayRejected:!1,yAxisLimit:null});function U(R){if(!u.value)return;const t=R.replace("</head>",`<style>
        html, body, body > div {
          height: 100%;
          margin: 0;
          padding: 0;
          overflow: hidden;
        }
      </style>
      </head>`);S&&(S.remove(),S=null);const d=document.createElement("iframe");d.style.width="100%",d.style.height="100%",d.style.border="none",u.value.innerHTML="",u.value.appendChild(d),d.srcdoc=t,S=d}async function C(){const R={...n.value,...i};await P(R)}function F(){T&&le(T,"text/html",`${Ce(n.value)}.html`)}async function P(R){L.value=!0,n.value=R,b.value=!0,a.value="",m.value="";try{if(T=(await ae.post("/chart_residuals",{...n.value,...i})).data,!T||T.trim()===""){a.value="Сервер вернул пустой ответ";return}h.value=!0,await _e(()=>{U(T)})}catch(t){const d=t;d.response?d.response.status===404?a.value=I.NOT_FOUND:d.response.status===400?a.value=I.INSUFFICIENT_PARAMS:d.response.status===401?a.value=d.response.data:d.response.status===413?m.value=d.response.data:a.value=I.DEFAULT:a.value=I.NO_CONNECTION,h.value=!1}finally{b.value=!1}}function q(){var R,t;S&&(S.src="about:blank",(R=S.contentWindow)==null||R.document.write(""),(t=S.contentWindow)==null||t.close(),S.remove(),S=null)}return ge(()=>{q(),T=""}),p({downloadHTML:P}),(R,t)=>(v(),V("div",He,[L.value?w("",!0):(v(),g(l(x),{key:0,severity:"info",closable:!1},{default:c(()=>t[5]||(t[5]=[N(" Выберите параметры для выгрузки графика невязок ")])),_:1})),E("div",Me,[E("div",qe,[E("span",Be,[k(l($),{id:"dataField",modelValue:i.dataField,"onUpdate:modelValue":t[0]||(t[0]=d=>i.dataField=d),options:l(Oe),optionLabel:"name",optionValue:"value",class:"w-full w-27rem"},null,8,["modelValue","options"]),t[6]||(t[6]=E("label",{for:"dataField",class:"block mb-1"},"Тип невязки",-1))]),E("span",ze,[k(l($),{id:"lineType",modelValue:i.lineType,"onUpdate:modelValue":t[1]||(t[1]=d=>i.lineType=d),options:l(Pe),optionLabel:"name",optionValue:"value",class:"w-full max-w-11rem"},null,8,["modelValue","options"]),t[7]||(t[7]=E("label",{for:"lineType",class:"block mb-1"},"Вид линии",-1))]),E("span",Qe,[k(l(ke),{inputIs:"yAxisLimit",modelValue:i.yAxisLimit,"onUpdate:modelValue":t[2]||(t[2]=d=>i.yAxisLimit=d),inputId:"integeronly",prefix:"±",suffix:" м",class:"w-full"},null,8,["modelValue"]),t[8]||(t[8]=E("label",{for:"yAxisLimit",class:"block mb-1"},"Границы оси Y, ±",-1))]),E("span",Ge,[k(l($),{id:"timeStep",modelValue:i.timeStep,"onUpdate:modelValue":t[3]||(t[3]=d=>i.timeStep=d),options:l(je),optionLabel:"name",optionValue:"value",class:"w-full w-8rem"},null,8,["modelValue","options"]),t[9]||(t[9]=E("label",{for:"timeStep",class:"block mb-1"},"Шаг по времени",-1))]),E("div",Ke,[k(l(Re),{class:"mr-2",inputId:"displayRejected",modelValue:i.displayRejected,"onUpdate:modelValue":t[4]||(t[4]=d=>i.displayRejected=d)},null,8,["modelValue"]),t[10]||(t[10]=E("label",{class:"text-sm max-w-10rem text-left",for:"displayRejected"},"Отображать отбракованные невязки",-1))]),k(l(X),{label:"Применить параметры и обновить",icon:"pi pi-refresh",onClick:C,loading:b.value,class:"mr-2"},null,8,["loading"]),k(l(X),{label:"Скачать HTML",icon:"pi pi-download",onClick:F,class:"p-button-secondary"})])]),b.value?(v(),g(l(x),{key:1,severity:"info",closable:!1},{default:c(()=>t[11]||(t[11]=[N("Идет загрузка...")])),_:1})):w("",!0),m.value?(v(),g(l(x),{key:2,class:"text-left",severity:"error",closable:!1,style:{"white-space":"pre-line"}},{default:c(()=>[N(D(m.value),1)]),_:1})):w("",!0),h.value||m.value?(v(),V("div",{key:3,ref_key:"graphContainer",ref:u,class:"graph-container",style:Se({display:h.value?"block":"none"})},null,4)):a.value?(v(),g(l(x),{key:4,severity:"error",closable:!1},{default:c(()=>[N(D(a.value),1)]),_:1})):w("",!0)]))}}),Ye=Le(We,[["__scopeId","data-v-ef3998c1"]]),aa=M({__name:"HistoryResiduals",setup(o){const p=y(0),n=Q(()=>p.value===0),b=Q(()=>p.value===1),h=Q(()=>p.value===2),a=y({}),m=y(!1),L=y(),u=y(),T=y();async function S(i){var U,C,F;a.value=i,n.value?(U=L.value)==null||U.getResiduals(i):h.value?(m.value=!0,await((C=u.value)==null?void 0:C.downloadCSV(i)),m.value=!1):b.value&&(m.value=!0,await((F=T.value)==null?void 0:F.downloadHTML(i)),m.value=!1)}return ee(()=>{var i;return(i=L.value)==null?void 0:i.checkIfLoading()},(i,U)=>{i&&(m.value=!0),U&&i===!1&&(m.value=!1)}),(i,U)=>(v(),V(H,null,[k(Te,{"is-with-bis":!0,"is-bis-with-generalized":!1,"is-with-signal-type":!0,"loading-state":m.value,"nka-mode":"multiple","bis-mode":"multiple","signal-mode":"multiple","nka-multiple-type":"sys","has-timestamp-choice":!0,"button-label":h.value?"Выгрузить CSV":"Отобразить",onQueryParams:S},null,8,["loading-state","button-label"]),k(l(Ne),{activeIndex:p.value,"onUpdate:activeIndex":U[0]||(U[0]=C=>p.value=C),lazy:!0,class:"tabview"},{default:c(()=>[k(l(G),{header:"Просмотр невязок"},{default:c(()=>[k(Ve,{ref_key:"historyResidualsTableView",ref:L,"query-params":a.value},null,8,["query-params"])]),_:1}),k(l(G),{header:"График невязок (HTML)"},{default:c(()=>[k(Ye,{ref_key:"historyResidualsHTMLImport",ref:T,"query-params":a.value},null,8,["query-params"])]),_:1}),k(l(G),{header:"Выгрузка невязок в файл (CSV)"},{default:c(()=>[k($e,{ref_key:"historyResidualsCSVImport",ref:u,"query-params":a.value},null,8,["query-params"])]),_:1})]),_:1},8,["activeIndex"])],64))}});export{aa as default};
