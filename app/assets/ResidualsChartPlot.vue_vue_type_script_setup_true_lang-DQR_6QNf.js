var D=Object.defineProperty;var w=(i,e,t)=>e in i?D(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var o=(i,e,t)=>w(i,typeof e!="symbol"?e+"":e,t);import{R as B,C as v,r as b,p as _,d as g}from"./knp-style-BUSAdRBo.js";import{G as O,E as x,ai as L,d as P,B as C,w as f,o as u,c as m,u as d,a as T,a6 as H,Z as K,v as R,t as k,l as h,F as G}from"./index-B9ncFhZ9.js";class j{constructor({data:e,depth:t}){o(this,"_data");o(this,"depth");this._data=e===void 0?[]:e,this.depth=t}get data(){return this._data}get length(){return this._data.length}append(e){this.expire();const t=e.sort((a,n)=>a.id-n.id);if(this._data.length===0){this._data=t;return}const s=this.data[this.data.length-1].id;for(let a=0;a<t.length;a+=1)if(t[a].id>s){this._data=this._data.concat(t.slice(a));break}}firstTimedeltaFromNow(){if(this.data.length===0)return this.depth;const e=new Date().getTime(),t=this.data[this.data.length-1].timestamp.getTime();return Math.ceil((e-t)/1e3)}expire(){const e=new Date().getTime()-this.depth*1e3;this._data=this._data.filter(t=>t.timestamp.getTime()>e)}}function S(i,e){return i.reduce((s,a)=>(s[a[e]]=s[a[e]]||[],s[a[e]].push(a),s),Object.create(null))}class z extends L{constructor({url:t,updateRate:s,depth:a,startImmediately:n}){super({url:t,updateRate:s,startImmediately:n});o(this,"depth",30);o(this,"groupBy");o(this,"groupedData");o(this,"currentLimit",30);this.depth=a===void 0?30:a,this.groupedData={}}calculateCurrentLimit(){let t=this.depth;if(Object.values(this.groupedData).length===0)return t;if(this.groupBy){for(const s in this.groupedData)if(Object.prototype.hasOwnProperty.call(this.groupedData,s)){const a=this.groupedData[s].firstTimedeltaFromNow();a<t&&a>0&&(t=a)}}return t}expireBuffers(){if(this.groupBy)for(const t in this.groupedData)Object.prototype.hasOwnProperty.call(this.groupedData,t)&&this.groupedData[t].expire()}deleteEmptyBuffers(){if(this.groupBy)for(const t in this.groupedData)Object.prototype.hasOwnProperty.call(this.groupedData,t)&&delete this.groupedData[t]}emptyData(){this.groupedData={},this.available=!1}determineGetParams(){return this.currentLimit=this.calculateCurrentLimit(),{limit:this.currentLimit}}processRecievedData(t){if(this.expireBuffers(),this.groupBy){const s=S(t,this.groupBy);for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&(this.groupedData[a]||(this.groupedData[a]=new j({depth:this.depth})),this.groupedData[a].append(s[a]))}}setDepth(t){this.stop(),this.whenLoaded(()=>{this.depth=t,this.emptyData(),this.start()})}setGroup(t){this.stop(),this.whenLoaded(()=>{this.groupBy=t,this.emptyData(),this.start()})}whenLoaded(t){this.loading?setTimeout(()=>{this.whenLoaded(t)},100):t()}}function F({url:i,updateRate:e,depth:t,startImmediately:s}){const a=O(new z({url:i,depth:t,updateRate:e,startImmediately:s}));return x(()=>{a.stop()}),a}const E={key:1},N={key:2,class:"lds-ring"},M=P({__name:"ResidualsChartPlot",props:{yValues:{},groupBy:{},depth:{},updateRate:{},id:{},namingKey:{},colors:{},names:{}},setup(i){const e=i;typeof window<"u"&&(window.ResizeObserver=window.ResizeObserver||B),v.register(...b,_);const t=F({url:"/residuals",depth:e.depth,updateRate:e.updateRate,startImmediately:!1});t.setGroup(e.groupBy);function s(r){t.emptyData(),t.getParams={},t.getParams[e.namingKey]=r}s(e.id),t.start();const a={options:{animation:!1,parsing:{xAxisKey:"timestamp",yAxisKey:e.yValues},scales:{x:{type:"time",time:{tooltipFormat:"HH:mm:ss",displayFormats:{millisecond:"HH:mm:ss",second:"HH:mm:ss",minute:"HH:mm",hour:"HH"}},title:{display:!0,text:"ДМВ"}},y:{title:{display:!0,text:"[м]"}}},plugins:{zoom:{zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"y"}}}}},n=C(()=>{const r={};return t.available&&e.id&&t.groupedData!==void 0?(r.datasets=Object.values(t.groupedData),r.datasets.forEach((p,l)=>{if(p.length!==0){const c=r.datasets[l].data[0];c!==void 0&&(r.datasets[l].label=e.names[c[e.groupBy]],r.datasets[l].backgroundColor=e.colors[c[e.groupBy]])}}),r):{datasets:[]}}),{scatterChartProps:y}=g.useScatterChart({chartData:n,...a});return f(()=>e.depth,r=>{t.setDepth(r)}),f(()=>e.id,r=>{s(r)}),(r,p)=>(u(),m(G,null,[d(t).available?(u(),T(d(g.ScatterChart),H(K({key:0},d(y))),null,16)):R("",!0),d(t).available?(u(),m("p",E,"Последнее обновление "+k(d(t).lastGet),1)):(u(),m("div",N,p[0]||(p[0]=[h("div",null,null,-1),h("div",null,null,-1),h("div",null,null,-1),h("div",null,null,-1)])))],64))}});export{M as _,F as k};
